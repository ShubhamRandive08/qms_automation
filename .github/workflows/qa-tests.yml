name: QA E2E Tests

# TRIGGER OPTIONS (choose one):

# OPTION A: Manual trigger only (simplest)
on:
  workflow_dispatch:    # Only manual runs from GitHub UI

# OPTION B: On push to main + manual
# on:
#   push:
#     branches: [ "main" ]
#   workflow_dispatch:

jobs:
  run-qa-tests:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci
      
      # 4. Install Playwright browsers
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      
      # 5. âœ… UPDATED: Setup QA environment (DEFAULT SETUP - no .env.qa needed)
      - name: Setup QA Environment
        run: |
          echo "ðŸ”§ Setting up QA Environment with DEFAULTS"
          
          # Create .env file with QA defaults
          cat > .env << 'EOF'
          # ===========================================
          # QA ENVIRONMENT DEFAULTS
          # ===========================================
          ENV=qa
          BASE_URL=https://qa.your-application.com
          USERNAME=Admin
          PASSWORD=admin123
          HEADLESS=true
          TIMEOUT=30000
          SLOW_MO=0
          VIEWPORT_WIDTH=1280
          VIEWPORT_HEIGHT=720
          # ===========================================
          EOF
          
          # Add GitHub metadata
          echo "GITHUB_RUN_ID=${{ github.run_id }}" >> .env
          echo "GITHUB_SHA=${{ github.sha }}" >> .env
          echo "GITHUB_REF_NAME=${{ github.ref_name }}" >> .env
          echo "GITHUB_ACTOR=${{ github.actor }}" >> .env
          
          # Display configuration
          echo ""
          echo "ðŸ“‹ QA Environment Configuration:"
          echo "=================================="
          cat .env
          echo "=================================="
      
      # 6. Run QA Tests
      - name: Run Tests
        run: npm run test:qa
        env:
          # Pass environment variables directly
          ENV: qa
          HEADLESS: true
          TIMEOUT: 30000
      
      # 7. Generate HTML Report (no upload needed)
      - name: Generate Report
        if: always()
        run: |
          # Create simple HTML report
          echo "ðŸ“Š Generating test report..."
          
          # Check if playwright-report exists
          if [ -d "playwright-report" ]; then
            echo "âœ… Playwright report found"
            npx playwright show-report playwright-report --host 0.0.0.0 --port 8080 &
          else
            echo "âš ï¸ No playwright report found, creating simple report"
            mkdir -p playwright-report
            cat > playwright-report/index.html << 'EOF'
            <!DOCTYPE html>
            <html>
            <head>
                <title>QA Test Report - Run ${{ github.run_id }}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 40px; }
                    .header { background: #0366d6; color: white; padding: 20px; border-radius: 5px; }
                    .info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>ðŸ§ª QA Test Report</h1>
                    <p>Default QA Environment Tests</p>
                </div>
                <div class="info">
                    <h3>Test Run Details</h3>
                    <p><strong>Run ID:</strong> ${{ github.run_id }}</p>
                    <p><strong>Environment:</strong> qa (default)</p>
                    <p><strong>Date:</strong> $(date)</p>
                    <p><strong>Commit:</strong> ${{ github.sha }}</p>
                    <p><strong>Status:</strong> Tests executed with default QA configuration</p>
                </div>
                <p>Check GitHub Actions logs for detailed results.</p>
                <p><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Action Logs</a></p>
            </body>
            </html>
            EOF
          fi
          
          # Create a simple summary file
          echo "ðŸ“ Creating test summary..."
          cat > test-summary.md << 'EOF'
          # QA Test Run - ${{ github.run_id }}
          
          ## Summary
          - **Date:** $(date)
          - **Status:** ${{ job.status }}
          - **Environment:** qa (default configuration)
          - **Commit:** ${{ github.sha }}
          - **Branch:** ${{ github.ref_name }}
          - **Triggered by:** ${{ github.actor }}
          
          ## Configuration Used
          - **ENV:** qa
          - **BASE_URL:** https://qa.your-application.com
          - **USERNAME:** qa_test_user
          - **PASSWORD:** ********
          - **HEADLESS:** true
          - **TIMEOUT:** 30000ms
          
          ## Notes
          This run used DEFAULT QA environment configuration since .env.qa file was not provided.
          
          To use custom configuration:
          1. Create `.env.qa` file in repository root
          2. Add your QA environment variables
          3. Re-run the workflow
          
          ## Links
          - [View Action Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)
          EOF
          
          echo "âœ… Report generation complete"
      
      # 8. Upload Test Results (optional - for debugging)
      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-test-results-${{ github.run_id }}
          path: |
            test-results/
            playwright-report/
            test-summary.md
            .env
          retention-days: 7  # Keep for 7 days only