name: QA E2E Tests

# TRIGGER OPTIONS (choose one):

# OPTION A: Manual trigger only (simplest)
on:
  workflow_dispatch:    # Only manual runs from GitHub UI

# OPTION B: On push to main + manual
# on:
#   push:
#     branches: [ "main" ]
#   workflow_dispatch:

jobs:
  run-qa-tests:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci
      
      # 4. Install Playwright browsers
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      
      # 5. UPDATED: Setup QA environment (DEFAULT SETUP - no .env.qa needed)
      - name: Setup QA Environment
        run: |
          echo "ðŸ”§ Setting up QA Environment with DEFAULTS"
          
          # Create .env file with QA defaults
          cat > .env << 'EOF'
          # ===========================================
          # QA ENVIRONMENT DEFAULTS
          # ===========================================
          ENV=qa
          BASE_URL=https://opensource-demo.orangehrmlive.com
          USERNAME=Admin
          PASSWORD=admin123
          HEADLESS=true
          TIMEOUT=30000
          SLOW_MO=0
          VIEWPORT_WIDTH=1280
          VIEWPORT_HEIGHT=720
          # ===========================================
          EOF
          
          # Add GitHub metadata
          echo "GITHUB_RUN_ID=${{ github.run_id }}" >> .env
          echo "GITHUB_SHA=${{ github.sha }}" >> .env
          echo "GITHUB_REF_NAME=${{ github.ref_name }}" >> .env
          echo "GITHUB_ACTOR=${{ github.actor }}" >> .env
          
          # Display configuration
          echo ""
          echo "ðŸ“‹ QA Environment Configuration:"
          echo "=================================="
          cat .env
          echo "=================================="
      
      # 6. Run QA Tests
      - name: Run Tests
        run: npm run test:qa
        env:
          # Pass environment variables directly
          BASE_URL : https://opensource-demo.orangehrmlive.com
          ENV: qa
          HEADLESS: true
          TIMEOUT: 30000
      
      # 7. Upload Test Results (optional - for debugging)
      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-test-results-${{ github.run_id }}
          path: |
            test-results/
            playwright-report/
            test-summary.md
            .env
          retention-days: 7  # Keep for 7 days only